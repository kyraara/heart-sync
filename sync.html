<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heart Sync - Sentuh Bersama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;600;700&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a1f 50%, #2a0a2a 100%);
            height: 100vh;
            touch-action: none;
            user-select: none;
        }

        .romantic-title {
            font-family: 'Playfair Display', serif;
        }

        .handwritten {
            font-family: 'Dancing Script', cursive;
        }

        /* Touch Screen */
        #touchScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Orbs */
        .orb {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            filter: blur(2px);
            opacity: 0;
            pointer-events: none;
        }

        .orb-user1 {
            background: radial-gradient(circle, #ff006e, #ff006e00);
            box-shadow: 0 0 60px rgba(255, 0, 110, 0.8);
            left: 10%;
            top: 50%;
            transform: translateY(-50%);
        }

        .orb-user2 {
            background: radial-gradient(circle, #8338ec, #8338ec00);
            box-shadow: 0 0 60px rgba(131, 56, 236, 0.8);
            right: 10%;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Orb name labels */
        .orb-label {
            position: absolute;
            bottom: -28px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            text-shadow: 0 0 10px rgba(255, 0, 110, 0.8);
            opacity: 0;
        }

        /* Merged Heart */
        .merged-heart {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            pointer-events: none;
            filter: drop-shadow(0 0 40px rgba(255, 0, 110, 0.8));
        }

        /* Names display after merge */
        .merged-names {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, calc(-50% + 150px));
            text-align: center;
            opacity: 0;
            pointer-events: none;
            z-index: 100;
            width: 90vw;
            max-width: 500px;
        }

        .merged-names .names-text {
            font-family: 'Dancing Script', cursive;
            font-size: 2.2rem;
            font-weight: 700;
            color: #fff;
            text-shadow: 
                0 0 10px rgba(255, 0, 110, 0.8),
                0 0 30px rgba(255, 0, 110, 0.5),
                0 0 60px rgba(131, 56, 236, 0.3);
        }

        .merged-names .ampersand {
            color: #ff69b4;
            font-size: 1.5rem;
            margin: 0 10px;
            text-shadow: 0 0 15px rgba(255, 0, 110, 0.7);
        }

        /* Progress Ring */
        .progress-container {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.1s linear;
            stroke: url(#progressGradient);
            stroke-width: 8;
            fill: none;
            stroke-linecap: round;
        }

        /* Particles */
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ff006e;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
        }

        /* Sparkle particles */
        .sparkle {
            position: absolute;
            pointer-events: none;
            opacity: 0;
        }

        /* Status Badge */
        .status-badge {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Pulse animation */
        @keyframes pulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.05);
                opacity: 0.8;
            }
        }

        .pulse-active {
            animation: pulse 1s ease-in-out infinite;
        }

        /* Heartbeat */
        @keyframes heartbeat {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            25% { transform: translate(-50%, -50%) scale(1.1); }
            50% { transform: translate(-50%, -50%) scale(1); }
        }

        /* Success overlay */
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        /* Confetti */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff006e;
            opacity: 0;
        }

        /* Glow burst effect */
        .glow-burst {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,0,110,0.6), rgba(131,56,236,0.3), transparent);
            transform: translate(-50%, -50%);
            pointer-events: none;
            opacity: 0;
        }

        /* Music Button */
        .music-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff006e, #8338ec);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(255, 0, 110, 0.4);
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .music-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 30px rgba(255, 0, 110, 0.6);
        }

        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .music-playing {
            animation: spin-slow 3s linear infinite;
        }
    </style>
</head>
<body>

    <!-- Background Music -->
    <audio id="bgMusic" loop preload="auto">
        <source src="https://cdn.pixabay.com/audio/2024/11/29/audio_f0c43fbd43.mp3" type="audio/mpeg">
    </audio>

    <!-- Music Toggle Button -->
    <button id="musicBtn" class="music-btn" title="Musik">
        üéµ
    </button>
    
    <!-- Touch Screen -->
    <div id="touchScreen"></div>

    <!-- Top Status Bar -->
    <div class="fixed top-0 left-0 right-0 z-50 p-4">
        <div class="max-w-md mx-auto">
            <div class="status-badge rounded-2xl p-4 text-center">
                <p class="text-white text-sm mb-2" id="statusText">Menghubungkan...</p>
                <div class="flex justify-center gap-4 text-xs">
                    <span class="text-pink-400" id="user1Status">Kamu: Belum Siap</span>
                    <span class="text-purple-400" id="user2Status">Pasangan: Belum Siap</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Center Instruction -->
    <div id="instruction" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-40 text-center">
        <div class="mb-8">
            <div class="progress-container mx-auto mb-6">
                <svg class="progress-ring" width="200" height="200">
                    <defs>
                        <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ff006e;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#8338ec;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle class="progress-ring-circle" stroke="#333" stroke-width="8" fill="none" r="90" cx="100" cy="100" />
                    <circle id="progressCircle" class="progress-ring-circle" r="90" cx="100" cy="100" 
                            stroke-dasharray="565.48" stroke-dashoffset="565.48" />
                </svg>
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                    <p class="text-6xl mb-2" id="countdownText">3</p>
                    <p class="text-white text-sm" id="progressText">0%</p>
                </div>
            </div>
        </div>
        
        <h2 class="romantic-title text-4xl md:text-5xl text-white mb-4">
            Sentuh & Tahan
        </h2>
        <p class="text-pink-300 text-lg mb-2">
            Tekan layar bersama-sama
        </p>
        <p class="text-gray-500 text-sm">
            Tahan selama 3 detik untuk menyinkronkan hati kalian
        </p>
    </div>

    <!-- Orbs with name labels -->
    <div id="orb1" class="orb orb-user1">
        <span id="orb1Label" class="orb-label"></span>
    </div>
    <div id="orb2" class="orb orb-user2">
        <span id="orb2Label" class="orb-label"></span>
    </div>

    <!-- Glow Burst -->
    <div id="glowBurst" class="glow-burst"></div>

    <!-- Merged Heart -->
    <div id="mergedHeart" class="merged-heart">
        <svg width="200" height="200" viewBox="0 0 100 100">
            <defs>
                <linearGradient id="heartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#ff006e;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#8338ec;stop-opacity:1" />
                </linearGradient>
            </defs>
            <path fill="url(#heartGradient)" d="M50,90 C50,90 10,65 10,40 C10,25 20,15 30,15 C40,15 50,25 50,25 C50,25 60,15 70,15 C80,15 90,25 90,40 C90,65 50,90 50,90 Z"/>
        </svg>
    </div>

    <!-- Names after merge -->
    <div id="mergedNames" class="merged-names">
        <span id="name1Display" class="names-text"></span>
        <span class="ampersand">&</span>
        <span id="name2Display" class="names-text"></span>
    </div>

    <!-- Success Overlay -->
    <div id="successOverlay" class="success-overlay">
        <div class="text-center px-4">
            <div class="mb-8">
                <svg width="150" height="150" viewBox="0 0 100 100" class="mx-auto">
                    <defs>
                        <linearGradient id="successGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ff006e;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#8338ec;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path fill="url(#successGradient)" d="M50,90 C50,90 10,65 10,40 C10,25 20,15 30,15 C40,15 50,25 50,25 C50,25 60,15 70,15 C80,15 90,25 90,40 C90,65 50,90 50,90 Z"/>
                </svg>
            </div>
            <h1 class="romantic-title text-5xl md:text-6xl text-white mb-4">
                Koneksi Terjalin
            </h1>
            <p id="successNames" class="handwritten text-3xl text-pink-300 mb-6"></p>
            <p class="text-pink-300 text-2xl mb-12">
                Selamanya üíï
            </p>
            <button id="openMessageBtn" class="bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white font-semibold py-4 px-8 rounded-full text-lg transition-all duration-300 transform hover:scale-105">
                Buka Pesan Kami üíå
            </button>
        </div>
    </div>

    <!-- Particle Container -->
    <div id="particleContainer"></div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, set, onValue, update } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCBJI5DwaPfLlLBCWHyUWjpEYJTd2EGvJg",
            authDomain: "heart-sync-valentine.firebaseapp.com",
            databaseURL: "https://heart-sync-valentine-default-rtdb.firebaseio.com",
            projectId: "heart-sync-valentine",
            storageBucket: "heart-sync-valentine.firebasestorage.app",
            messagingSenderId: "648055518881",
            appId: "1:648055518881:web:4d6c99ad54f20ca518e2e0"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Get Room ID & Name
        const params = new URLSearchParams(window.location.search);
        const roomId = params.get('room');
        const userName = params.get('name') || localStorage.getItem('heartSyncName') || 'Kamu';

        if (!roomId) {
            alert('Kode ruangan tidak ditemukan!');
            window.location.href = 'index.html';
        }

        // Elements
        const touchScreen = document.getElementById('touchScreen');
        const statusText = document.getElementById('statusText');
        const user1Status = document.getElementById('user1Status');
        const user2Status = document.getElementById('user2Status');
        const progressCircle = document.getElementById('progressCircle');
        const countdownText = document.getElementById('countdownText');
        const progressText = document.getElementById('progressText');
        const instruction = document.getElementById('instruction');
        const orb1 = document.getElementById('orb1');
        const orb2 = document.getElementById('orb2');
        const orb1Label = document.getElementById('orb1Label');
        const orb2Label = document.getElementById('orb2Label');
        const mergedHeart = document.getElementById('mergedHeart');
        const mergedNames = document.getElementById('mergedNames');
        const name1Display = document.getElementById('name1Display');
        const name2Display = document.getElementById('name2Display');
        const successOverlay = document.getElementById('successOverlay');
        const successNames = document.getElementById('successNames');
        const openMessageBtn = document.getElementById('openMessageBtn');
        const glowBurst = document.getElementById('glowBurst');

        // State
        let userId = Math.random().toString(36).substr(2, 9);
        let isHolding = false;
        let syncStartTime = null;
        let syncInterval = null;
        let animationTriggered = false;
        let partnerName = 'Pasangan';
        let allNames = [];

        const SYNC_DURATION = 3000; // 3 seconds
        const circumference = 2 * Math.PI * 90;
        progressCircle.style.strokeDasharray = circumference;

        // Database refs
        const syncRef = ref(database, `rooms/${roomId}/sync`);
        const userStateRef = ref(database, `rooms/${roomId}/sync/${userId}`);

        // Initialize user state
        set(userStateRef, {
            holding: false,
            name: userName,
            timestamp: Date.now()
        });

        // Also read room users to get names
        const usersRef = ref(database, `rooms/${roomId}/users`);
        onValue(usersRef, (snapshot) => {
            const users = snapshot.val();
            if (!users) return;
            const names = Object.values(users).map(u => u.name).filter(Boolean);
            if (names.length > 0) allNames = names;
        });

        // Listen to sync state
        onValue(syncRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            const users = Object.keys(data);
            const holdingUsers = users.filter(uid => data[uid].holding);

            // Collect names from sync data
            const syncNames = users.map(uid => data[uid].name).filter(Boolean);
            if (syncNames.length > 0) allNames = [...new Set([...allNames, ...syncNames])];

            // Find partner name
            const partnerId = users.find(uid => uid !== userId);
            if (partnerId && data[partnerId]?.name) {
                partnerName = data[partnerId].name;
            }

            // Update status
            if (users.length >= 2) {
                statusText.textContent = 'Kedua hati terhubung!';
            }

            // Update individual status
            const isUser1Holding = data[userId]?.holding || false;
            const partnerIds = users.filter(uid => uid !== userId);
            const isUser2Holding = partnerIds.some(uid => data[uid]?.holding);

            user1Status.textContent = `Kamu: ${isUser1Holding ? 'üíï Siap' : 'Belum Siap'}`;
            user2Status.textContent = `${partnerName}: ${isUser2Holding ? 'üíï Siap' : 'Belum Siap'}`;

            // Check if both holding
            if (holdingUsers.length === 2 && !animationTriggered) {
                if (!syncStartTime) {
                    syncStartTime = Date.now();
                    startSyncAnimation();
                }
            } else {
                if (syncStartTime && !animationTriggered) {
                    // Reset if one releases
                    resetSync();
                }
            }
        });

        // Touch handlers
        let touchStarted = false;

        touchScreen.addEventListener('mousedown', handleTouchStart);
        touchScreen.addEventListener('touchstart', handleTouchStart);
        touchScreen.addEventListener('mouseup', handleTouchEnd);
        touchScreen.addEventListener('touchend', handleTouchEnd);
        touchScreen.addEventListener('mouseleave', handleTouchEnd);

        function handleTouchStart(e) {
            e.preventDefault();
            if (animationTriggered) return;
            
            touchStarted = true;
            isHolding = true;
            update(userStateRef, {
                holding: true,
                timestamp: Date.now()
            });

            // Visual feedback
            instruction.classList.add('pulse-active');
            
            // Vibrate
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        function handleTouchEnd(e) {
            if (!touchStarted) return;
            touchStarted = false;
            isHolding = false;
            
            update(userStateRef, {
                holding: false,
                timestamp: Date.now()
            });

            instruction.classList.remove('pulse-active');
        }

        // Sync Animation
        function startSyncAnimation() {
            let elapsed = 0;

            syncInterval = setInterval(() => {
                elapsed = Date.now() - syncStartTime;
                const progress = Math.min(elapsed / SYNC_DURATION, 1);
                
                // Update progress ring
                const offset = circumference - (progress * circumference);
                progressCircle.style.strokeDashoffset = offset;
                
                // Update countdown
                const remaining = Math.ceil((SYNC_DURATION - elapsed) / 1000);
                countdownText.textContent = remaining;
                progressText.textContent = `${Math.floor(progress * 100)}%`;

                if (progress >= 1) {
                    clearInterval(syncInterval);
                    triggerHeartMerge();
                }
            }, 50);
        }

        function resetSync() {
            syncStartTime = null;
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
            progressCircle.style.strokeDashoffset = circumference;
            countdownText.textContent = '3';
            progressText.textContent = '0%';
        }

        // Heart Merge Animation
        function triggerHeartMerge() {
            animationTriggered = true;
            
            // Vibrate success
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }

            // Set orb labels
            orb1Label.textContent = userName;
            orb2Label.textContent = partnerName;

            // Hide instruction
            gsap.to(instruction, {
                opacity: 0,
                scale: 0.8,
                duration: 0.5
            });

            // Show orbs with labels
            gsap.to([orb1, orb2], {
                opacity: 1,
                duration: 0.5,
                onComplete: () => {
                    // Show orb labels 
                    gsap.to([orb1Label, orb2Label], {
                        opacity: 1,
                        duration: 0.3
                    });

                    // Animate orbs to center
                    gsap.to(orb1, {
                        left: '50%',
                        duration: 2,
                        ease: 'power2.inOut',
                        x: '-50%'
                    });

                    gsap.to(orb2, {
                        right: '50%',
                        duration: 2,
                        ease: 'power2.inOut',
                        x: '50%',
                        onComplete: () => {
                            // Hide orbs + labels
                            gsap.to([orb1, orb2], {
                                opacity: 0,
                                scale: 0,
                                duration: 0.3
                            });

                            // Glow burst effect
                            gsap.to(glowBurst, {
                                opacity: 0.8,
                                width: '400px',
                                height: '400px',
                                duration: 0.4,
                                ease: 'power2.out',
                                onComplete: () => {
                                    gsap.to(glowBurst, {
                                        opacity: 0,
                                        width: '600px',
                                        height: '600px',
                                        duration: 0.8
                                    });
                                }
                            });

                            // Show merged heart
                            gsap.to(mergedHeart, {
                                opacity: 1,
                                scale: 1,
                                duration: 0.5,
                                ease: 'back.out',
                                onComplete: () => {
                                    // Heartbeat
                                    mergedHeart.style.animation = 'heartbeat 1s ease-in-out 3';
                                    
                                    // Show names below heart
                                    name1Display.textContent = userName;
                                    name2Display.textContent = partnerName;
                                    gsap.to(mergedNames, {
                                        opacity: 1,
                                        y: -10,
                                        duration: 0.8,
                                        delay: 0.3,
                                        ease: 'power2.out'
                                    });

                                    // Create particles
                                    createParticleBurst();
                                    createSparkles();

                                    // Show success after heartbeat
                                    setTimeout(() => {
                                        showSuccess();
                                    }, 3500);
                                }
                            });
                        }
                    });
                }
            });
        }

        // Particle Burst
        function createParticleBurst() {
            const container = document.getElementById('particleContainer');
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;

            for (let i = 0; i < 60; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                particle.style.background = i % 2 === 0 ? '#ff006e' : '#8338ec';
                particle.style.width = (Math.random() * 6 + 2) + 'px';
                particle.style.height = particle.style.width;
                
                const angle = (Math.PI * 2 * i) / 60;
                const velocity = 80 + Math.random() * 150;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;

                container.appendChild(particle);

                gsap.to(particle, {
                    x: tx,
                    y: ty,
                    opacity: 1,
                    duration: 0.5,
                    ease: 'power2.out',
                    onComplete: () => {
                        gsap.to(particle, {
                            opacity: 0,
                            duration: 0.8,
                            onComplete: () => particle.remove()
                        });
                    }
                });
            }
        }

        // Sparkle effect
        function createSparkles() {
            const container = document.getElementById('particleContainer');
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            const sparkleChars = ['‚ú¶', '‚úß', '‚≠ê', 'üí´', '‚ú®'];

            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.textContent = sparkleChars[Math.floor(Math.random() * sparkleChars.length)];
                    sparkle.style.left = (centerX + (Math.random() - 0.5) * 200) + 'px';
                    sparkle.style.top = (centerY + (Math.random() - 0.5) * 200) + 'px';
                    sparkle.style.fontSize = (Math.random() * 20 + 12) + 'px';

                    container.appendChild(sparkle);

                    gsap.to(sparkle, {
                        opacity: 1,
                        y: -(Math.random() * 60 + 30),
                        scale: 1.5,
                        duration: 0.6,
                        ease: 'power2.out',
                        onComplete: () => {
                            gsap.to(sparkle, {
                                opacity: 0,
                                y: '-=20',
                                duration: 0.5,
                                onComplete: () => sparkle.remove()
                            });
                        }
                    });
                }, i * 100);
            }
        }

        // Show Success
        function showSuccess() {
            successNames.textContent = `${userName} & ${partnerName}`;
            successOverlay.style.display = 'flex';
            gsap.fromTo(successOverlay, 
                { opacity: 0 },
                { opacity: 1, duration: 0.5 }
            );

            // Create confetti
            createConfetti();
        }

        // Confetti
        function createConfetti() {
            const container = successOverlay;
            const colors = ['#ff006e', '#8338ec', '#3a86ff', '#00ff88', '#ffbe0b'];

            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * window.innerWidth + 'px';
                    confetti.style.top = '-10px';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.width = Math.random() * 10 + 5 + 'px';
                    confetti.style.height = confetti.style.width;
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                    
                    container.appendChild(confetti);

                    gsap.to(confetti, {
                        y: window.innerHeight + 100,
                        x: (Math.random() - 0.5) * 200,
                        rotation: Math.random() * 720,
                        opacity: 1,
                        duration: 3 + Math.random() * 2,
                        ease: 'power1.out',
                        onComplete: () => confetti.remove()
                    });
                }, i * 30);
            }
        }

        // Open Message
        openMessageBtn.addEventListener('click', () => {
            window.location.href = `message.html?room=${roomId}&name=${encodeURIComponent(userName)}&partner=${encodeURIComponent(partnerName)}`;
        });
    </script>

    <!-- Music Control Script -->
    <script>
        const bgMusic = document.getElementById('bgMusic');
        const musicBtn = document.getElementById('musicBtn');
        let isMusicPlaying = false;

        bgMusic.volume = 0.3;

        function toggleMusic() {
            if (isMusicPlaying) {
                bgMusic.pause();
                musicBtn.textContent = 'üéµ';
                musicBtn.classList.remove('music-playing');
                localStorage.setItem('heartSyncMusic', 'off');
            } else {
                bgMusic.play().then(() => {
                    musicBtn.textContent = 'üé∂';
                    musicBtn.classList.add('music-playing');
                    localStorage.setItem('heartSyncMusic', 'on');
                }).catch(() => {});
            }
            isMusicPlaying = !isMusicPlaying;
        }

        musicBtn.addEventListener('click', toggleMusic);

        if (localStorage.getItem('heartSyncMusic') === 'on') {
            bgMusic.play().then(() => {
                isMusicPlaying = true;
                musicBtn.textContent = 'üé∂';
                musicBtn.classList.add('music-playing');
            }).catch(() => {});
        }

        document.addEventListener('click', function autoPlay() {
            if (!isMusicPlaying && localStorage.getItem('heartSyncMusic') !== 'off') {
                bgMusic.play().then(() => {
                    isMusicPlaying = true;
                    musicBtn.textContent = 'üé∂';
                    musicBtn.classList.add('music-playing');
                    localStorage.setItem('heartSyncMusic', 'on');
                }).catch(() => {});
            }
            document.removeEventListener('click', autoPlay);
        }, { once: true });
    </script>

</body>
</html>
